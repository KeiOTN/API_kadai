<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Image Analysis</title>
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- ç”»åƒåˆ†æå‚è€ƒã‚µã‚¤ãƒˆ -->
    <!-- https://qiita.com/KMim/items/884b237f962066fb78eb -->
    <!-- Google cloud Vision APIç”»åƒåˆ†æã¯1,000æšã¾ã§ç„¡æ–™/æœˆ -->
    <!-- ç¿»è¨³å‚è€ƒã‚µã‚¤ãƒˆ -->
    <!-- Cloud Translation APIç¿»è¨³ã¯500,000å­—ã¾ã§ç„¡æ–™/æœˆ -->
    <!-- https://note.com/npaka/n/n1766dbe194b4 -->

    <h3 id='title'>å†™çœŸã«ãªã«ãŒå†™ã£ã¦ã„ã‚‹ã‹ãªï¼Ÿ</h3>
    <!--- ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ãŸã‚ã®ãƒœã‚¿ãƒ³ã®ã‚ã‚‹ã‚¨ãƒªã‚¢ --->
    <div id="uploadArea">
        <l>èª¿ã¹ãŸã„å†™çœŸã‚’é¸ã‚“ã§ã­â†’ </l><input type="file" id="uploader">
    </div>
    <div class="resultArea resultWrapper hidden">
        <div class=right-and-left>
            <!-- å·¦å³åŠåˆ†ãšã¤ã«é…ç½® -->
            <div class="photo-and-chart">
                <!-- å†™çœŸè¡¨ç¤ºã¨æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆ,ï¼ˆï¼‹ãƒ†ã‚­ã‚¹ãƒˆè§£æï¼‰BOX -->
                <div class="photo-area" id="showPic">
                    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´æ‰€ -->
                </div>
                <div class="emoion-area" id="chartArea">
                    <!-- æ„Ÿæƒ…åˆ†æçµæœ/äººç‰©ã®è¡¨æƒ…ã«é–¢ã™ã‚‹çµæœã‚’ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§è¡¨ç¤º  -->
                </div> <!-- emoion END -->
                <div class="text-result">
                    <table id="textTable">
                        <!-- ãƒ†ã‚­ã‚¹ãƒˆåˆ†æçµæœ -->
                        <thead>
                            <tr>
                                <td><b>ã“ã®å†™çœŸã«ã¯ã©ã‚“ãªæ–‡å­—ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã‹ãª...ï¼Ÿ</b></td>
                            </tr>
                        </thead>
                        <tbody id="textBox"></tbody>
                    </table>
                </div> <!-- text-result END -->
            </div> <!-- photo-and-chart END -->

            <div class="label-result">
                <!-- ãƒ©ãƒ™ãƒ«åˆ†æçµæœ -->
                <table id="resultTable-English">
                    <thead class="English-words">
                        <tr>
                            <td><b>ã“ã®å†™çœŸã¯ã«å†™ã£ã¦ã„ã‚‹ã®ã¯...</b></td>
                        </tr>
                    </thead>
                    <tbody id="resultBox-English"></tbody>
                </table>
                <table id="resultTable-Japanese">
                    <thead class="Japanese-words">
                        <tr>
                            <td><b>æ—¥æœ¬èªã«ã™ã‚‹ã¨...</b></td>
                        </tr>
                    </thead>
                    <tbody id="resultBox-Japanese"></tbody>
                </table>
                <table id="resultTable-Japanese-lid">
                    <thead class="Japanese-words-lid">
                        <tr>
                            <td></td>
                        </tr>
                    </thead>
                    <tbody id="resultBox-Japanese-lid"></tbody>
                </table>
            </div> <!-- label-result END -->
        </div> <!-- right-and-left END -->



    </div> <!-- resultArea resultWrapper END -->





    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--- è¡¨æƒ…åˆ†æã®çµæœã‚’ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§è¡¨ã™ãŸã‚ã«ä»¥ä¸‹ã®äºŒã¤ã‚’ç”¨ã„ã‚‹ --->
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="http://code.highcharts.com/highcharts-more.js"></script>
    <!-- <script type="text/javascript" src="CloudVision.js"></script> -->

    <script> // ç¿»è¨³æ©Ÿèƒ½
        // è‹±â†’å’Œ
        function translateEngToJap(x) {
            let apiKey = 'ç¿»è¨³APIkey'
            let text = x
            let fromLang = 'en'
            let toLang = 'ja'
            const URL = "https://translation.googleapis.com/language/translate/v2?key=" + apiKey +
                "&q=" + encodeURI(text) + "&source=" + fromLang + "&target=" + toLang
            let xhr = new XMLHttpRequest()
            xhr.open('POST', [URL], false)
            xhr.send();
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.responseText);
                // alert(res["data"]["translations"][0]["translatedText"]);
                return res["data"]["translations"][0]["translatedText"];
            }
        }

        // å’Œâ†’è‹±
        function translateJapToEng(y) {
            let apiKey = 'ç¿»è¨³APIkey'
            let text = y
            let fromLang = 'ja'
            let toLang = 'en'
            const URL = "https://translation.googleapis.com/language/translate/v2?key=" + apiKey +
                "&q=" + encodeURI(text) + "&source=" + fromLang + "&target=" + toLang
            let xhr = new XMLHttpRequest()
            xhr.open('POST', [URL], false)
            xhr.send();
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.responseText);
                // alert(res["data"]["translations"][0]["translatedText"]);
                return res["data"]["translations"][0]["translatedText"];
            }
        }
    </script>

    <script>// ç”»åƒè§£æ
        //section 1
        //APIã‚’åˆ©ç”¨ã™ã‚‹éš›ã®URL
        var KEY = 'ç”»åƒè§£æAPIkey'
        var url = 'https://vision.googleapis.com/v1/images:annotate?key='
        var api_url = url + KEY

        //section 2
        //ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€éš›ã«å‹•çš„ã«ãƒ©ãƒ™ãƒ«æ¤œå‡ºçµæœè¡¨ç¤ºç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
        $(function () {
            for (var i = 0; i < 20; i++) {
                $("#resultBox-English").append("<tr><td class='resultTableContent-English'></td></tr>");
                $("#resultBox-Japanese").append("<tr><td class='resultTableContent-Japanese " + "JP" + i + "'></td></tr>");
            }
        })

        //section 3
        //ç”»é¢ã®è¡¨ç¤ºå†…å®¹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†
        function clear() {
            if ($("#textBox tr").length) {
                $("#textBox tr").remove();
            }
            if ($("#chartArea div").length) {
                $("#chartArea div").remove();
            }
            $("#resultBox-English tr td").text("");
            $("#resultBox-Japanese tr td").text("")
        }

        //section 4
        //ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæ™‚ç‚¹ã§å‘¼ã³å‡ºã•ã‚Œã‚‹å‡¦ç†
        $("#uploader").change(function (evt) {
            getImageInfo(evt);
            clear();
            $(".resultArea").removeClass("hidden")
        })

        //section 5
        //ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®URLã‚’çµ„ã¿ç«‹ã¦ã‚‹
        function getImageInfo(evt) {
            var file = evt.target.files;
            var reader = new FileReader();
            var dataUrl = "";
            reader.readAsDataURL(file[0]);
            reader.onload = function () {
                dataUrl = reader.result;
                $("#showPic").html("<img src='" + dataUrl + "'>");
                makeRequest(dataUrl, getAPIInfo);
            }
        }

        //section 6
        //APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«çµ„ã¿è¾¼ã‚€Jsonã®çµ„ã¿ç«‹ã¦
        function makeRequest(dataUrl, callback) {
            var end = dataUrl.indexOf(",")
            var request = "{'requests': [{'image': {'content': '" + dataUrl.slice(end + 1) + "'},'features': [{'type': 'LABEL_DETECTION','maxResults': 20,},{'type': 'FACE_DETECTION',},{'type':'TEXT_DETECTION','maxResults': 20,}]}]}"
            callback(request)
        }

        //section 7
        //é€šä¿¡ã‚’è¡Œã†
        function getAPIInfo(request) {
            $.ajax({
                url: api_url,
                type: 'POST',
                async: true,
                cashe: false,
                data: request,
                dataType: 'json',
                contentType: 'application/json',
            }).done(function (result) {
                showResult(result);
            }).fail(function (result) {
                alert('failed to load the info');
            });
        }

        //section 8ï¼šå¾—ã‚‰ã‚ŒãŸçµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
        function showResult(result) {
            //8-1 ãƒ©ãƒ™ãƒ«æ¤œå‡ºçµæœã®è¡¨ç¤º
            // console.log(result.responses[0].labelAnnotations);
            // console.log(result.responses[0].labelAnnotations.description); // undefined
            var EnglishArrayWords = [];// ãƒ©ãƒ™ãƒ«ã®è‹±èªè¡¨è¨˜ã‚’å…¥ã‚Œã‚‹é…åˆ—
            for (var i = 0; i < result.responses[0].labelAnnotations.length; i++) {
                $("#resultBox-English tr:eq(" + i + ") td").text(result.responses[0].labelAnnotations[i].description)
                EnglishArrayWords.push(result.responses[0].labelAnnotations[i].description);
            }
            // console.log(EnglishArrayWords);  // å…¥ã£ãŸ

            // forEachã§æ›¸ãã¨
            // let html = '';
            // let JapaneseArrayWords = []; // æ—¥æœ¬èªã«ç¿»è¨³ã—ãŸã®ã‚’å…¥ã‚Œã‚‹é…åˆ—
            // var translatedWords = '';   // æ—¥æœ¬èªã«ãªã£ãŸwords
            // //æ—¥æœ¬èªã«ç¿»è¨³ã•ã‚ŒãŸã‚‚ã®ã‚’æŠ•å…¥
            // EnglishArrayWords.forEach(function (EnglishArrayWord) {
            //     // console.log(EnglishArrayWord);
            //     translatedWords = translateEngToJap(EnglishArrayWord);
            //     // console.log(translatedWords);
            //     JapaneseArrayWords.push(translatedWords);
            //     html += '<li>' + translatedWords + '</li>';
            // });
            // document.querySelector('ul').innerHTML = html;
            // // è¡¨ç¤ºã‚‚OK,è¡¨ç¤ºå ´æ‰€èª¿æ•´å¿…è¦
            // // console.log(translatedWords);
            // // console.log(JapaneseArrayWords); // æ—¥æœ¬èªé…åˆ—OK

            // forã§æ›¸ãæ›ãˆ
            let JapaneseArrayWords = []; // æ—¥æœ¬èªã«ç¿»è¨³ã—ãŸã®ã‚’å…¥ã‚Œã‚‹é…åˆ—
            var translatedWords = '';   // æ—¥æœ¬èªã«ãªã£ãŸwordsï¼ˆnoté…åˆ—ï¼‰
            translatedWords = translateEngToJap(EnglishArrayWords);
            console.log(translatedWords);
            var spllitWords = translatedWords.split('ã€');

            for (var i = 0; i < spllitWords.length; i++) {

                japanese = spllitWords[i];
                console.log(japanese);// OK:é…åˆ—ã®è¦ç´ ã‚’ã²ã¨ã¤ã¥ã¤
                $("#resultBox-Japanese tr:eq(" + i + ") td").html('<a onclick="openbox(\'JP' + i + '\', \'' + japanese + '\')">??</a >')
                //æ—¥æœ¬èªã‚’ï¼Ÿã§éš ã™


                //console.log(spllitWords);
                // JapaneseArrayWords.push(translatedWords); // é…åˆ—ã«æŠ•å…¥
                // console.log(JapaneseArrayWords);// NG:ä¸€è¡Œã«ç¿»è¨³å…¨æŠ•å…¥Ã—20è¡Œã«ãªã£ãŸw
                // $("#resultBox-Japanese tr:eq(" + i + ") td").text(translatedWords)// NG:åŒä¸Šã€ä¸€è¡Œã«ç¿»è¨³å…¨æŠ•å…¥Ã—20è¡Œã«ãªã£ãŸw
            }


            //8-2 è¡¨æƒ…åˆ†æã®çµæœã®è¡¨ç¤º
            if (result.responses[0].faceAnnotations) {
                //ã“ã®å¤‰æ•°ã«ã€è¡¨æƒ…ã®likelihoodã®å€¤ã‚’é…åˆ—ã¨ã—ã¦ä¿æŒã™ã‚‹
                var facialExpression = [];
                facialExpression.push(result.responses[0].faceAnnotations[0].joyLikelihood);
                facialExpression.push(result.responses[0].faceAnnotations[0].sorrowLikelihood);
                facialExpression.push(result.responses[0].faceAnnotations[0].angerLikelihood);
                facialExpression.push(result.responses[0].faceAnnotations[0].surpriseLikelihood);
                facialExpression.push(result.responses[0].faceAnnotations[0].headwearLikelihood);
                for (var k = 0; k < facialExpression.length; k++) {
                    if (facialExpression[k] == 'UNKNOWN') {
                        facialExpression[k] = 0;
                    } else if (facialExpression[k] == 'VERY_UNLIKELY') {
                        facialExpression[k] = 2;
                    } else if (facialExpression[k] == 'UNLIKELY') {
                        facialExpression[k] = 4;
                    } else if (facialExpression[k] == 'POSSIBLE') {
                        facialExpression[k] = 6;
                    } else if (facialExpression[k] == 'LIKELY') {
                        facialExpression[k] = 8;
                    } else if (facialExpression[k] == 'VERY_LIKELY') {
                        facialExpression[k] = 10;
                    }
                }
                //8-3 ãƒãƒ£ãƒ¼ãƒˆæç”»ã®å‡¦ç†
                $("#chartArea").highcharts({
                    chart: {
                        polar: true,
                        type: 'line'
                    },
                    title: {
                        text: 'ã“ã®äººã¯ã©ã‚“ãªæ°—æŒã¡ã‹ãªï¼Ÿ',
                        // text: 'Expression of a person',
                    },
                    pane: {
                        size: '80%'
                    },
                    xAxis: {
                        categories: ['joyğŸ˜Š', 'sorrowğŸ˜¢', 'angerğŸ˜¡', 'surpriseğŸ˜²', 'headwearğŸ§¢'],
                        tickmarkPlacement: 'on',
                        lineWidth: 0
                    },
                    yAxis: {
                        gridLineInterpolation: 'polygon',
                        lineWidth: 0,
                        max: 10,
                        min: 0
                    },
                    tooltip: {
                        shared: true,
                        pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y:,.0f}</b><br/>'
                    },
                    series: [{
                        // name: 'å¯èƒ½æ€§',
                        name: 'likelihood',
                        data: facialExpression,
                        pointPlacement: 'on'
                    }]
                })
            } else {
                //è¡¨æƒ…ã«é–¢ã™ã‚‹çµæœãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã€è¡¨ç¤ºæ¬„ã«ã¯ãã®æ—¨ã‚’è¨˜ã™æ–‡å­—åˆ—ã‚’è¡¨ç¤º
                $("#chartArea").append("<div><b>ã“ã®å†™çœŸã«äººã¯å†™ã£ã¦ã„ãªã„ã­</b></div>");
            }
            //8-4 ãƒ†ã‚­ã‚¹ãƒˆè§£èª­ã®çµæœã‚’è¡¨ç¤º
            if (result.responses[0].textAnnotations) {
                for (var j = 1; j < result.responses[0].textAnnotations.length; j++) {
                    if (j < 16) {
                        $("#textBox").append("<tr><td class='resultTableContent'>" + result.responses[0].textAnnotations[j].description + "</td></tr>")
                    }
                }
            } else {
                //ãƒ†ã‚­ã‚¹ãƒˆã«é–¢ã™ã‚‹çµæœãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã€è¡¨ç¤ºæ¬„ã«ã¯ãã®æ—¨ã‚’è¨˜ã™æ–‡å­—åˆ—ã‚’è¡¨ç¤º
                $("#textBox").append("<tr><td class='resultTableContent'><b>æ–‡å­—ã¯ã‚ã‚Šã¾ã›ã‚“</b></td></tr>")
            }
        }

        // æ—¥æœ¬èªè¨³ã‚’hide&show

        function openbox(classname, jptxt) {
            $("." + classname).text(jptxt);
        }

    </script>

</body>

</html>